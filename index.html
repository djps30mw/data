<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Plant Data App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex flex-col items-center min-h-screen">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Use the provided global variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        setLogLevel('Debug');

        const authStateChangePromise = new Promise(resolve => {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                    document.getElementById('auth-section').classList.add('hidden');
                    document.getElementById('app-content').classList.remove('hidden');
                    console.log("User logged in with UID:", userId);
                    setupFirestoreListener(userId);
                } else {
                    document.getElementById('user-id-display').textContent = 'User ID: N/A';
                    document.getElementById('auth-section').classList.remove('hidden');
                    document.getElementById('app-content').classList.add('hidden');
                    console.log("User logged out.");
                    clearLogList();
                }
                resolve();
            });
        });

        window.addEventListener('load', async () => {
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } catch (error) {
                    console.error("Error signing in with custom token:", error);
                    await signInAnonymously(auth);
                }
            } else {
                await signInAnonymously(auth);
                console.log("Signed in anonymously.");
            }
        });

        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showMessage("Account created successfully!");
            } catch (error) {
                showMessage(`Error creating account: ${error.message}`);
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage("Logged in successfully!");
            } catch (error) {
                showMessage(`Error logging in: ${error.message}`);
            }
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                showMessage("Logged out successfully!");
            } catch (error) {
                showMessage(`Error logging out: ${error.message}`);
            }
        });

        document.getElementById('add-log-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const logEntry = {
                timestamp: new Date().toISOString(),
                operator: document.getElementById('operator-name').value,
                reading: document.getElementById('gauge-reading').value,
                notes: document.getElementById('log-notes').value,
            };

            const collectionPath = `artifacts/${appId}/users/${userId}/log_sheets`;
            
            try {
                await addDoc(collection(db, collectionPath), logEntry);
                document.getElementById('operator-name').value = '';
                document.getElementById('gauge-reading').value = '';
                document.getElementById('log-notes').value = '';
                showMessage("Log entry added successfully!");
            } catch (error) {
                showMessage(`Error adding log entry: ${error.message}`);
            }
        });

        function setupFirestoreListener(currentUserId) {
            const collectionPath = `artifacts/${appId}/users/${currentUserId}/log_sheets`;
            onSnapshot(collection(db, collectionPath), (snapshot) => {
                clearLogList();
                const logs = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    logs.push({ id: doc.id, ...data });
                });
                renderLogs(logs);
            });
        }

        function renderLogs(logs) {
            const logList = document.getElementById('log-list');
            logs.forEach(log => {
                const li = document.createElement('li');
                li.className = 'bg-gray-700 p-4 rounded-xl shadow-lg mb-2 flex justify-between items-start space-x-4';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'flex-grow';
                
                const timestamp = new Date(log.timestamp).toLocaleString();
                contentDiv.innerHTML = `
                    <div class="font-semibold text-lg text-emerald-300">Timestamp: ${timestamp}</div>
                    <div class="text-sm text-gray-400">Operator: ${log.operator}</div>
                    <div class="text-sm text-gray-400">Gauge Reading: ${log.reading}</div>
                    <p class="mt-2 text-gray-300">${log.notes}</p>
                `;
                li.appendChild(contentDiv);
                logList.appendChild(li);
            });
        }

        function clearLogList() {
            const logList = document.getElementById('log-list');
            logList.innerHTML = '';
        }

        function showMessage(message) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }
    </script>

    <!-- Global Message Box -->
    <div id="message-box" class="fixed top-4 right-4 bg-emerald-500 text-white p-4 rounded-xl shadow-xl transition-opacity duration-300 hidden z-50"></div>

    <!-- Main Container -->
    <div class="w-full max-w-lg mx-auto bg-gray-800 p-6 rounded-3xl shadow-2xl">

        <!-- Header -->
        <h1 class="text-4xl sm:text-5xl font-extrabold text-center text-emerald-400 mb-2">Power Plant</h1>
        <p class="text-center text-sm sm:text-base text-gray-400 mb-8">Data & Log Sheet</p>
        <div id="user-id-display" class="text-sm text-center text-gray-500 mb-4">User ID: N/A</div>

        <!-- Authentication Section (hidden when logged in) -->
        <div id="auth-section" class="space-y-6">
            <div class="bg-gray-700 p-6 rounded-2xl shadow-lg">
                <h2 class="text-xl font-bold text-white mb-4 text-center">Login</h2>
                <form id="login-form" class="space-y-4">
                    <input type="email" id="login-email" placeholder="Email" required class="w-full px-4 py-3 bg-gray-600 text-white border-none rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-400">
                    <input type="password" id="login-password" placeholder="Password" required class="w-full px-4 py-3 bg-gray-600 text-white border-none rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-400">
                    <button type="submit" class="w-full bg-emerald-500 text-white font-bold py-3 px-4 rounded-xl hover:bg-emerald-600 transition-colors duration-200">Log In</button>
                </form>
            </div>
            
            <div class="bg-gray-700 p-6 rounded-2xl shadow-lg">
                <h2 class="text-xl font-bold text-white mb-4 text-center">Sign Up</h2>
                <form id="signup-form" class="space-y-4">
                    <input type="email" id="signup-email" placeholder="Email" required class="w-full px-4 py-3 bg-gray-600 text-white border-none rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-400">
                    <input type="password" id="signup-password" placeholder="Password" required class="w-full px-4 py-3 bg-gray-600 text-white border-none rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-400">
                    <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-600 transition-colors duration-200">Sign Up</button>
                </form>
            </div>
        </div>

        <!-- App Content (hidden before login) -->
        <div id="app-content" class="hidden space-y-8">
            <button id="logout-btn" class="w-full bg-rose-500 text-white font-bold py-3 px-4 rounded-xl hover:bg-rose-600 transition-colors duration-200 mb-6">Log Out</button>

            <!-- New Log Entry Form -->
            <div class="bg-gray-700 p-6 rounded-2xl shadow-lg">
                <h2 class="text-xl font-bold text-white mb-4">Add a Log Entry</h2>
                <form id="add-log-form" class="space-y-4">
                    <input type="text" id="operator-name" placeholder="Operator Name" required class="w-full px-4 py-3 bg-gray-600 text-white border-none rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-400">
                    <input type="text" id="gauge-reading" placeholder="Gauge Reading" required class="w-full px-4 py-3 bg-gray-600 text-white border-none rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-400">
                    <textarea id="log-notes" placeholder="Notes" rows="4" required class="w-full px-4 py-3 bg-gray-600 text-white border-none rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-400"></textarea>
                    <button type="submit" class="w-full bg-emerald-500 text-white font-bold py-3 px-4 rounded-xl hover:bg-emerald-600 transition-colors duration-200">Add Log</button>
                </form>
            </div>
            
            <!-- Log Entries List -->
            <div class="bg-gray-700 p-6 rounded-2xl shadow-lg">
                <h2 class="text-xl font-bold text-white mb-4">Recent Logs</h2>
                <ul id="log-list" class="space-y-4">
                    <!-- Log entries will be rendered here dynamically -->
                </ul>
            </div>
        </div>

    </div>

</body>
</html>
